# Connect an external S3-like Object Store

This guide explains how to __use an external S3-like object store__ with deployKF.

---

## Overview

deployKF includes an embedded [MinIO](https://min.io/) instance, however, you may want to replace this with an external S3-compatible object store.

!!! danger "Production Usage"

    Currently, the embedded MinIO is only intended for development and testing purposes as it only supports a single replica.
    In future, we are considering adding support for a high-availability MinIO cluster.

??? warning "MinIO License"
  
    Ensure you are familiar with MinIO's licence, which at the time of writing is [AGPLv3](https://github.com/minio/minio/blob/master/LICENSE).
    However, rest assured that deployKF itself __does NOT contain any code from MinIO__, and is licensed under the [Apache 2.0 License](https://github.com/deployKF/deployKF/blob/main/LICENSE).

??? info "Supported Object Stores"

    deployKF should work with any S3-compatible object store!

    Here are some S3-compatible object stores listed by platform:
    
    Platform | Object Store
    --- | ---
    Amazon Web Services | [Amazon Simple Storage Service (S3)](https://aws.amazon.com/s3/)
    Microsoft Azure | [Azure Blob Storage](https://azure.microsoft.com/en-us/services/storage/blobs/)
    Google Cloud | [Google Cloud Storage](https://cloud.google.com/storage)
    Alibaba Cloud | [Alibaba Cloud Object Storage Service (OSS)](https://www.alibabacloud.com/product/oss)
    IBM Cloud | [IBM Cloud Object Storage](https://www.ibm.com/cloud/object-storage)
    Other | [MinIO](https://min.io/), [Ceph](https://ceph.io/), [Wasabi](https://wasabi.com/)

## 1. Disable Embedded MinIO

The [`deploykf_opt.deploykf_minio.enabled`](https://github.com/deployKF/deployKF/blob/v0.1.1/generator/default_values.yaml#L853) value controls if the embedded MinIO instance is deployed.

For example, to disable MinIO, set the following value:

```yaml
deploykf_opt:
  deploykf_minio:
    enabled: false
```

## 2. Connect Kubeflow Pipelines

To connect Kubeflow Pipelines to your external object store, you will need to configure the [`kubeflow_tools.pipelines.objectStore`](https://github.com/deployKF/deployKF/blob/v0.1.1/generator/default_values.yaml#L1669-L1678) values.

For example, you may set values like this:

```yaml
kubeflow_tools:
  pipelines:
    objectStore:
      ## this must be true to enable external object store
      useExternal: true
      
      ## this specifies the REST endpoint for your object store
      host: s3.amazonaws.com
      port: ""
      useSSL: true
```

!!! warning "S3-Compatible Object Stores Only"

    Currently, Kubeflow Pipelines only supports S3-compatible object store HTTP APIs.
    This means that while you can use services like [Google Cloud Storage](https://cloud.google.com/storage), you will need to use their S3-compatible [XML API](https://cloud.google.com/storage/docs/xml-api/overview), and features like [GKE Workload Identity](https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity) will NOT work.

    If you would like Kubeflow Pipelines to implement support for the native APIs of your object store, please raise this with the upstream Kubeflow Pipelines community.

### Bucket

The following values configure which bucket is used by Kubeflow Pipelines:

??? value "[`kubeflow_tools.pipelines.bucket`](https://github.com/deployKF/deployKF/blob/v0.1.1/generator/default_values.yaml#L1663-L1667)"

    These values configure the bucket used by Kubeflow Pipelines (v1)

??? value "[`kubeflow_tools.pipelines.kfpV2.defaultPipelineRoot`](https://github.com/deployKF/deployKF/blob/v0.1.1/generator/default_values.yaml#L1733-L1740)"

    These values configure the bucket used by Kubeflow Pipelines (v2)

### Authentication

You will need to configure authentication for Kubeflow Pipelines to access your object store.

??? warning "Bucket IAM Policies"

    When using the embedded MinIO, we automatically configure prefix-based IAM Policies for each profile.

    This is possible because of the "key format" structure we use for pipeline artifacts, which includes the name of the executing namespace/profile at the start of the key:

    - [`kubeflow_dependencies.kubeflow_argo_workflows.artifactRepository.keyFormat`](https://github.com/deployKF/deployKF/blob/v0.1.1/generator/default_values.yaml#L1179)
    - [`kubeflow_tools.pipelines.kfpV2.defaultPipelineRoot`](https://github.com/deployKF/deployKF/blob/v0.1.1/generator/default_values.yaml#L1740)

    To replicate this in your external object store, you may assign an IAM Policy for each profile that is similar to the ones generated by deployKF.

    The following IAM Policy is used by the Kubeflow Pipelines BACKEND:

    ```json
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Effect": "Allow",
          "Action": [
            "s3:GetBucketLocation",
            "s3:ListBucket"
          ],
          "Resource": [
            "arn:aws:s3:::<BUCKET_NAME>"
          ]
        },
        {
          "Effect": "Allow",
          "Action": [
            "s3:GetObject",
            "s3:PutObject",
            "s3:DeleteObject"
          ],
          "Resource": [
            "arn:aws:s3:::<BUCKET_NAME>/artifacts/*",
            "arn:aws:s3:::<BUCKET_NAME>/pipelines/*",
            "arn:aws:s3:::<BUCKET_NAME>/v2/artifacts/*"
          ]
        }
      ]
    }
    ```

    The following IAM Policy is used by the PROFILES:

    ```json
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Effect": "Allow",
          "Action": [
            "s3:GetBucketLocation",
            "s3:ListBucket"
          ],
          "Resource": [
            "arn:aws:s3:::<BUCKET_NAME>"
          ]
        },
        {
          "Effect": "Allow",
          "Action": [
            "s3:GetObject",
            "s3:PutObject",
            "s3:DeleteObject"
          ],
          "Resource": [
            "arn:aws:s3:::<BUCKET_NAME>/artifacts/<PROFILE_NAME>/*",
            "arn:aws:s3:::<BUCKET_NAME>/v2/artifacts/<PROFILE_NAME>/*"
          ]
        }
      ]
    }
    ```

??? config "Authenticate using Secret Keys (ALL Platforms)"

    The following values configure secret key-based auth for the __Kubeflow Pipelines Backend__, __Argo Workflows Controller__, and __Argo Server UI__.

    ??? value "[`kubeflow_tools.pipelines.objectStore.auth`](https://github.com/deployKF/deployKF/blob/v0.1.1/generator/default_values.yaml#L1680-L1704)"
    
        These values configure object store auth, for the __Kubeflow Pipelines Backend__, __Argo Workflows Controller__, and __Argo Server UI__.
    
    ??? value "[`deploykf_core.deploykf_profiles_generator.profileDefaults.tools.kubeflowPipelines.objectStoreAuth`](https://github.com/deployKF/deployKF/blob/v0.1.1/generator/default_values.yaml#L746-L774)"
    
        These values configure object store secret-based auth, for __things running in profiles__.

??? config "Authenticate using IRSA (AWS Only)"

    The following values configure IRSA-based auth for the __Kubeflow Pipelines Backend__, __Argo Workflows Controller__, and __Argo Server UI__.

    ??? value "[`kubeflow_dependencies.kubeflow_argo_workflows.controller.serviceAccount`](https://github.com/deployKF/deployKF/blob/v0.1.1/generator/default_values.yaml#L1185-L1190)"
    
        These values configure the Kubernetes ServiceAccounts used by the __Argo Workflows Controller__, including their annotations.
    
    ??? value "[`kubeflow_dependencies.kubeflow_argo_workflows.server.serviceAccount`](https://github.com/deployKF/deployKF/blob/v0.1.1/generator/default_values.yaml#L1196-L1201)"
    
        These values configure the Kubernetes ServiceAccounts used by the __Argo Server UI__, including their annotations.
    
    ??? value "[`kubeflow_tools.pipelines.serviceAccounts`](https://github.com/deployKF/deployKF/blob/v0.1.1/generator/default_values.yaml#L1647-L1661)"
    
        These values configure the Kubernetes ServiceAccounts used by the __Kubeflow Pipelines Backend__, including their annotations.
    
    ??? value "[`deploykf_core.deploykf_profiles_generator.profileDefaults.plugins`](https://github.com/deployKF/deployKF/blob/v0.1.1/generator/default_values.yaml#L706-L730)"
    
        These values configure profile-plugins. 
    
        The `AwsIamForServiceAccount` profile-plugin is used to configure AWS IRSA-based auth by annotating Kubernetes ServiceAccounts in the profile namespace.
    
        Note, these are the __default plugins__ for profiles which do NOT have their own `plugins` defined in their [`deploykf_core.deploykf_profiles_generator.profiles`](https://github.com/deployKF/deployKF/blob/v0.1.1/generator/default_values.yaml#L800-L839) list entry.